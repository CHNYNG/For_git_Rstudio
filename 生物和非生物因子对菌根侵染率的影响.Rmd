---
title: "生物和非生物因子对菌根侵染率的影响"
author: "cy"
date: "2023-05-15"
output: html_document
---
# 分析目标
目标主题的确定有利于进一步的分析，每次进来之前先看主题！！！（#后面记得加空格不然不识别

**生物-自身因素-植物自身（host）（host-colonization）**

**谱系是否保守（和数据库对照） 考虑谱系的距离（谱系信号）**

Y (colonization rate) ~ species identity （物种、大小）+ neighbors (邻体数量、类型、或许要分同种异种、是否加权谱系（CNDD系数（不同类型））) +soil+light+…*
 1. 首先，Y侵染率有了，需要的数据species identity应该是每个物种，这是个分类变量？或者分类+连续变量，就是host的侵染率，也有了。下面要解决的问题就是neighbors，那么先筛选出邻体？
 
 

```{r neighbors, include=FALSE}
#加载数据
load("E:/黑石顶测菌根/菌根侵染率/数据整理/tmp/For_git_Rstudio/root_qrl_soil.RData")
HSD <- read.csv("E:/Chu Lab/hsd.species.alive.cy.branch0.csv",header = TRUE,fileEncoding = "GBK" )
HSD <- HSD[,c("TagNew","Latin","Qudrat","Species","GX","GY","Status1","Status2","DBH1","DBH2","H","Family","Genus","Species.x","abundance")]
HSD_species <- subset(HSD, select = c(Family, Genus, Species.x, Species, Latin))
HSD_species <- unique(HSD_species)

# 创建一个空的数据框用于存储结果
result <- data.frame()

# 遍历d数据集的每一行
for (i in 1:nrow(d)) {
  # 计算当前行的点与HSD数据集中所有点的距离
  distances <- sqrt((d$GX[i] - HSD$GX)^2 + (d$GY[i] - HSD$GY)^2)
  
  # 筛选出距离小于10米的点的索引
  indices <- which(distances < 10)
  
  # 如果存在距离小于10米的点，则将这些点添加到结果数据框中
  if (length(indices) > 0) {
    result <- rbind(result, data.frame(d[i,c("TagNew") ], HSD[indices,c("TagNew") ]))
  }
}

#改一下列名，把focal的列名改为TagNew_f它的邻体为n
colnames(result) <- c("TagNew_f","TagNew_n")

#给TagNew_f和TagNew_n带上它们原本的数据
library(dplyr)

neighborselect <- left_join(result, HSD, by = c("TagNew_f" = "TagNew"))

neighborselect <- left_join(neighborselect, HSD, by = c("TagNew_n" = "TagNew"))

#整理一下列名
colnames(neighborselect) <- c("TagNew_f", "TagNew_n", "Latin_f", "Qudrat_F", "Species_f","GX_f",  "GY_f",  "Status1_f","Status2_F", "DBH1_f","DBH2_f", "H_f","Family_f",  "Genus_f",   "Species.x_f","abundance_f",
"Latin_n",   "Qudrat_n",  "Species_n", "GX_n", "GY_n", "Status1_n", "Status2_n", "DBH1_n", "DBH2_n","H_n",   "Family_n",  "Genus_n", "Species.x_n", "abundance_n")

#把距离打出来
neighborselect$distance <- sqrt((neighborselect$GX_f-neighborselect$GX_n)^2+(neighborselect$GY_f-neighborselect$GY_n)^2)

###给它们分个家，把同种和异种分出来
neighborselect$Type <- ifelse(neighborselect$Species_f == neighborselect$Species_n,
                              "homospecies", "heterspecies")

####提取物种对的信息
species_pairs <- unique(t(combn(unique(neighborselect$Species_f), 2)))
colnames(species_pairs) <- c("Species_f","Species_n")
species_pairs <- as.data.frame(species_pairs)
###把它们的物种信息合并进去
species_pairs <- left_join(species_pairs, HSD_species, by = c("Species_f" = "Species"))
species_pairs <- left_join(species_pairs, HSD_species, by = c("Species_n" = "Species"))


```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r cars}
summary(cars)
```

## Including Plots

You can also embed plots, for example:

```{r pressure, echo=FALSE}
plot(pressure)
```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
